<div class="auth-page">
  <div class="auth-card">

    <!-- Indicador de paso -->
    @if (!success()) {
      <div class="step-indicator" aria-label="Paso {{ step() }} de 2">
        <div class="step-indicator__item" [class.step-indicator__item--active]="step() === 1" [class.step-indicator__item--done]="step() === 2">
          <span class="step-indicator__dot">{{ step() === 2 ? '✓' : '1' }}</span>
          <span class="step-indicator__label">Verificar código</span>
        </div>
        <div class="step-indicator__line"></div>
        <div class="step-indicator__item" [class.step-indicator__item--active]="step() === 2">
          <span class="step-indicator__dot">2</span>
          <span class="step-indicator__label">Nueva contraseña</span>
        </div>
      </div>
    }

    <div class="auth-card__header">
      <h1 class="auth-card__title">Restablecer contraseña</h1>
    </div>

    <!-- Éxito -->
    <!-- Éxito -->
    @if (success()) {
      <div class="auth-card__alert auth-card__alert--success" role="status">
        ✅ Contraseña restablecida correctamente. Redirigiendo al inicio de sesión…
      </div>
    }

    <!-- Error del servidor -->
    @if (serverError()) {
      <div class="auth-card__alert auth-card__alert--error" role="alert">
        {{ serverError() }}
      </div>
    }

    @if (!success()) {

      <!-- ══════════════════════════════════════════
           PASO 1 — Verificar código
           ══════════════════════════════════════════ -->
      @if (step() === 1) {
        <p class="auth-card__description">
          Ingresa el email y el código de 6 dígitos que enviamos a tu correo.
        </p>

        <form (submit)="nextStep(); $event.preventDefault()" novalidate>

          <!-- Email -->
          <div class="form-group">
            <label for="rp-email" class="form-group__label">Email</label>
            <input
              id="rp-email"
              type="email"
              class="input"
              autocomplete="email"
              placeholder="tu@email.com"
              [value]="email()"
              (input)="updateField(email.set.bind(email), $event)"
              (blur)="emailTouched.set(true)"
              [attr.aria-invalid]="emailTouched() && emailError() ? 'true' : null" />
            @if (emailTouched() && emailError()) {
              <span class="form-error" role="alert">{{ emailError() }}</span>
            }
          </div>

          <!-- Código OTP -->
          <div class="form-group">
            <label for="rp-code" class="form-group__label">Código de verificación</label>
            <input
              id="rp-code"
              type="text"
              inputmode="numeric"
              pattern="\d{6}"
              maxlength="6"
              class="input input--code"
              autocomplete="one-time-code"
              placeholder="000000"
              [value]="code()"
              (input)="onCodeInput($event)"
              (blur)="codeTouched.set(true)"
              [attr.aria-invalid]="codeTouched() && codeError() ? 'true' : null" />
            @if (codeTouched() && codeError()) {
              <span class="form-error" role="alert">{{ codeError() }}</span>
            }
            <p class="form-hint">Revisa tu bandeja de entrada (y spam). El código expira en 15 minutos.</p>
          </div>

          <button type="submit" class="btn btn--primary auth-card__submit" [disabled]="loadingStep1()">
            @if (loadingStep1()) {
              <lucide-icon name="loader-2" [size]="16" class="spinner-icon" aria-hidden="true" />
              Verificando…
            } @else {
              Continuar
            }
          </button>
        </form>
      }

      <!-- ══════════════════════════════════════════
           PASO 2 — Nueva contraseña
           ══════════════════════════════════════════ -->
      @if (step() === 2) {
        <p class="auth-card__description">
          Elige una nueva contraseña segura para tu cuenta.
        </p>

        <form (submit)="onSubmit(); $event.preventDefault()" novalidate>

          <!-- Nueva contraseña -->
          <div class="form-group">
            <label for="rp-password" class="form-group__label">Nueva contraseña</label>
            <div class="form-group__input-wrapper">
              <input
                id="rp-password"
                [type]="showPassword() ? 'text' : 'password'"
                class="input"
                autocomplete="new-password"
                placeholder="Nueva contraseña"
                [value]="newPassword()"
                (input)="updateField(newPassword.set.bind(newPassword), $event)"
                (blur)="newPasswordTouched.set(true)"
                [attr.aria-invalid]="newPasswordTouched() && newPasswordError() ? 'true' : null" />
              <button
                type="button"
                class="form-group__toggle-password"
                (click)="showPassword.update(v => !v)"
                [attr.aria-label]="showPassword() ? 'Ocultar contraseña' : 'Mostrar contraseña'">
                <lucide-icon
                  [name]="showPassword() ? 'eye-off' : 'eye'"
                  [size]="18"
                  aria-hidden="true" />
              </button>
            </div>
            @if (newPasswordTouched() && newPasswordError()) {
              <span class="form-error" role="alert">{{ newPasswordError() }}</span>
            }
            <p class="form-hint">
              Mínimo 8 caracteres, al menos una letra mayúscula y un número.
            </p>
          </div>

          <!-- Confirmar contraseña -->
          <div class="form-group">
            <label for="rp-confirm" class="form-group__label">Confirmar contraseña</label>
            <div class="form-group__input-wrapper">
              <input
                id="rp-confirm"
                [type]="showConfirm() ? 'text' : 'password'"
                class="input"
                autocomplete="new-password"
                placeholder="Repite la contraseña"
                [value]="confirmPassword()"
                (input)="updateField(confirmPassword.set.bind(confirmPassword), $event)"
                (blur)="confirmPasswordTouched.set(true)"
                [attr.aria-invalid]="confirmPasswordTouched() && confirmPasswordError() ? 'true' : null" />
              <button
                type="button"
                class="form-group__toggle-password"
                (click)="showConfirm.update(v => !v)"
                [attr.aria-label]="showConfirm() ? 'Ocultar contraseña' : 'Mostrar contraseña'">
                <lucide-icon
                  [name]="showConfirm() ? 'eye-off' : 'eye'"
                  [size]="18"
                  aria-hidden="true" />
              </button>
            </div>
            @if (confirmPasswordTouched() && confirmPasswordError()) {
              <span class="form-error" role="alert">{{ confirmPasswordError() }}</span>
            }
          </div>

          <button
            type="submit"
            class="btn btn--primary auth-card__submit"
            [disabled]="loading()">
            @if (loading()) {
              <lucide-icon name="loader-2" [size]="16" class="spinner-icon" aria-hidden="true" />
              Guardando…
            } @else {
              Restablecer contraseña
            }
          </button>
        </form>

        <button
          type="button"
          class="btn--back"
          (click)="prevStep()">
          ← Volver al código
        </button>
      }
    }

    <nav class="auth-card__links" aria-label="Navegación de autenticación">
      <a routerLink="/auth/forgot-password" class="auth-card__link">Solicitar nuevo código</a>
      <span class="auth-card__link-sep" aria-hidden="true">·</span>
      <a routerLink="/auth/login" class="auth-card__link">Volver al inicio de sesión</a>
    </nav>
  </div>
</div>

