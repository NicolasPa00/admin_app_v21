<div class="auth-page">
  <div class="auth-card">
    <div class="auth-card__header">
      <h1 class="auth-card__title">Restablecer contrase√±a</h1>
    </div>

    <!-- √âxito -->
    @if (success()) {
      <div class="auth-card__alert auth-card__alert--success" role="status">
        ‚úÖ Contrase√±a restablecida correctamente. Redirigiendo al inicio de
        sesi√≥n‚Ä¶
      </div>
    }

    <!-- Error del servidor -->
    @if (serverError()) {
      <div class="auth-card__alert auth-card__alert--error" role="alert">
        {{ serverError() }}
      </div>
    }

    @if (!success()) {
      <p class="auth-card__description">
        Ingresa el c√≥digo de 6 d√≠gitos que enviamos a tu correo y elige tu
        nueva contrase√±a.
      </p>

      <form (submit)="onSubmit(); $event.preventDefault()" novalidate>

        <!-- Email (editable por si lleg√≥ vac√≠o) -->
        <div class="form-group">
          <label for="rp-email" class="form-group__label">Email</label>
          <input
            id="rp-email"
            type="email"
            class="input"
            autocomplete="email"
            placeholder="tu@email.com"
            [value]="email()"
            (input)="updateField(email.set.bind(email), $event)"
            (blur)="emailTouched.set(true)"
            [attr.aria-invalid]="emailTouched() && emailError() ? 'true' : null"
            [attr.aria-describedby]="emailTouched() && emailError() ? 'rp-email-error' : null" />
          @if (emailTouched() && emailError()) {
            <span id="rp-email-error" class="form-error" role="alert">
              {{ emailError() }}
            </span>
          }
        </div>

        <!-- C√≥digo OTP -->
        <div class="form-group">
          <label for="rp-code" class="form-group__label">
            C√≥digo de verificaci√≥n
            <span class="form-group__hint">6 d√≠gitos</span>
          </label>
          <input
            id="rp-code"
            type="text"
            inputmode="numeric"
            pattern="\d{6}"
            maxlength="6"
            class="input input--code"
            autocomplete="one-time-code"
            placeholder="123456"
            [value]="code()"
            (input)="onCodeInput($event)"
            (blur)="codeTouched.set(true)"
            [attr.aria-invalid]="codeTouched() && codeError() ? 'true' : null"
            [attr.aria-describedby]="codeTouched() && codeError() ? 'rp-code-error' : null" />
          @if (codeTouched() && codeError()) {
            <span id="rp-code-error" class="form-error" role="alert">
              {{ codeError() }}
            </span>
          }
        </div>

        <!-- Nueva contrase√±a -->
        <div class="form-group">
          <label for="rp-password" class="form-group__label">
            Nueva contrase√±a
          </label>
          <div class="form-group__input-wrapper">
            <input
              id="rp-password"
              [type]="showPassword() ? 'text' : 'password'"
              class="input"
              autocomplete="new-password"
              placeholder="M√≠n. 8 caracteres, 1 may√∫scula, 1 n√∫mero"
              [value]="newPassword()"
              (input)="updateField(newPassword.set.bind(newPassword), $event)"
              (blur)="newPasswordTouched.set(true)"
              [attr.aria-invalid]="newPasswordTouched() && newPasswordError() ? 'true' : null"
              [attr.aria-describedby]="newPasswordTouched() && newPasswordError() ? 'rp-password-error' : null" />
            <button
              type="button"
              class="form-group__toggle-password"
              (click)="togglePasswordVisibility()"
              [attr.aria-label]="showPassword() ? 'Ocultar contrase√±a' : 'Mostrar contrase√±a'">
              @if (showPassword()) { <span aria-hidden="true">üôà</span> }
              @else { <span aria-hidden="true">üëÅÔ∏è</span> }
            </button>
          </div>
          @if (newPasswordTouched() && newPasswordError()) {
            <span id="rp-password-error" class="form-error" role="alert">
              {{ newPasswordError() }}
            </span>
          }
        </div>

        <!-- Confirmar contrase√±a -->
        <div class="form-group">
          <label for="rp-confirm" class="form-group__label">
            Confirmar contrase√±a
          </label>
          <input
            id="rp-confirm"
            type="password"
            class="input"
            autocomplete="new-password"
            placeholder="Repite la contrase√±a"
            [value]="confirmPassword()"
            (input)="updateField(confirmPassword.set.bind(confirmPassword), $event)"
            (blur)="confirmPasswordTouched.set(true)"
            [attr.aria-invalid]="confirmPasswordTouched() && confirmPasswordError() ? 'true' : null"
            [attr.aria-describedby]="confirmPasswordTouched() && confirmPasswordError() ? 'rp-confirm-error' : null" />
          @if (confirmPasswordTouched() && confirmPasswordError()) {
            <span id="rp-confirm-error" class="form-error" role="alert">
              {{ confirmPasswordError() }}
            </span>
          }
        </div>

        <button
          type="submit"
          class="btn btn--primary auth-card__submit"
          [disabled]="loading()">
          @if (loading()) {
            <span class="spinner" aria-hidden="true"></span>
            Verificando‚Ä¶
          } @else {
            Restablecer contrase√±a
          }
        </button>
      </form>
    }

    <nav class="auth-card__links" aria-label="Navegaci√≥n de autenticaci√≥n">
      <a routerLink="/auth/forgot-password" class="auth-card__link">
        Solicitar nuevo c√≥digo
      </a>
      <span class="auth-card__link-sep" aria-hidden="true">¬∑</span>
      <a routerLink="/auth/login" class="auth-card__link">
        Volver al inicio de sesi√≥n
      </a>
    </nav>
  </div>
</div>

